---
title: 小程序开发-用户信息获取三连
date: 2019-5-21 17:29:12
categories:
    - 小程序
tags: 
    - 小程序
mathjax: true
---
最近接连做了两个小程序，把做的过程中走过的一些坑还有经验记录一下。

### 为什么获取用户信息

对于一个小程序来说，获取用户信息往往是第一步。有了用户信息就可以对产品的用户群体进行管理，为后续的支付、通知等功能做好铺垫。

### 有哪些用户信息

一般来说我们要获取的信息有两类

*   用户的登陆信息userinfo。微信的头像、昵称、位置等。所有在小程序中可以作为用户端身份识别的信息。
*   用户的openid。每一个用户在不同的环境登陆小程序都会自动产生一个独立的openid，作为每一个用户真实的身份索引。两个用户的头像、名称、位置信息可能完全相同，但是openid一定是一对一。在后台我们往往将openid作为真实的身份索引。

### 获取userinfo

曾将获取userinfo可以在用户进入小程序的时候实现自动弹窗。但在微信进行更新之后这个接口被修改了，必须要用户自主的点击获取个人信息的button之后才可以。

![img](https://s2.ax1x.com/2019/05/23/VC3DBR.png)

个人感觉这样的确是更安全的，但所有更安全的举动会让开发变得难受。

下面的代码中，我开始在app.js设置了全局的userinfo，此处方法是直接将值送到全局变量中。

```js
//js
getUserInfo: function (e) {
    console.log(e)
    app.globalData.userInfo = e.detail.userInfo
    this.setData({
      userInfo: e.detail.userInfo,
      hasUserInfo: true
    })
  },
```

同时要绑定到button来实现。此处的button需要加判断条件显示。CanIUse是一个内置的微信api，意义为用户是否同意获取自身的openid。

```xml
<button wx:if="{{!hasUserInfo && canIUse}}" open-type="getUserInfo" bindgetuserinfo="getUserInfo"> 获取头像昵称 </button>
    <block wx:else>
```

### 获取openid

获取openid同样是十分重要，在后台我们往往使用openid作为用户的唯一索引。并且openid的生成与有没有userinfo没有关系。

可以理解为openid是当前用户进入程序时发出的门票，我们可以先不知道用户的姓名，但是一定可以知道哪一个用户拿着这张票。

鉴于此，我们将获取openid的过程放在app.js，作为全局函数。我们使用云函数来获取openid，在app.js中调用云函数并进行存储。

```js
// 云函数入口文件
const cloud = require('wx-server-sdk')
cloud.init() //获取用户的openid
exports.main = async(event, context) => {
  return event.userInfo;
  //返回用户信息
}

//app.js
 wx.cloud.callFunction({
      name: 'login1',
      data: {},
      success: res => {
        console.log('[云函数] [login1] user openid: ', res.result.openid)
        wx.setStorageSync("openid", res.result.openid)
      },
      fail: err => {
        console.error('[云函数] [login1] 调用失败', err)
      }
    })
  },

  ```


最后我们openid存储到本地缓存。调用的时候可以直接从缓存中调取。

                